---
title: "more_exploring"
author: "Josh Marvald"
date: "5/29/2020"
output: html_document
---

```{r}
library(tidyverse)
source("merging_matches.R")
```


```{r}
# variable for ranking inside top 30 or outside top 30
gs_matches_final2 <-
  gs_matches_final %>%
  mutate(top30 = case_when(
    win == 0 & loser_rank <= 30 ~ "top30",
    win == 0 & loser_rank > 30 ~ "outside_top30",
    win == 0 & is.na(loser_rank) == TRUE ~ "outside_top30",
    win == 1 & winner_rank <= 30 ~ "top30",
    win == 1 & winner_rank > 30 ~ "outside_top30",
    win == 1 & is.na(winner_rank) == TRUE ~ "outside_top30"
  )) %>%
  mutate(opponent_top30 = case_when(
    win == 0 & winner_rank <= 30 ~ "top30",
    win == 0 & winner_rank > 30 ~ "outside_top30",
    win == 0 & is.na(winner_rank) == TRUE ~ "outside_top30",
    win == 1 & loser_rank <= 30 ~ "top30",
    win == 1 & loser_rank > 30 ~ "outside_top30",
    win == 1 & is.na(loser_rank) == TRUE ~ "outside_top30"
  )) %>%
  mutate(opponent_ranking = case_when(
    win == 0 & winner_rank <= 10 ~ "top10",
    win == 0 & 10 < winner_rank & winner_rank <= 30 ~ "10_to_30",
    win == 0 & winner_rank > 30 ~ "outside_top30",
    win == 0 & is.na(winner_rank) == TRUE ~ "outside_top30",
    win == 1 & loser_rank <= 10 ~ "top10",
    win == 1 & 10 < loser_rank & loser_rank <= 30 ~ "10_to_30",
    win == 1 & loser_rank > 30 ~ "outside_top30",
    win == 1 & is.na(loser_rank) == TRUE ~ "outside_top30"))


```


```{r}
# win vs first serve

ggplot(gs_matches_final2, aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.1) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()

gs_matches_final2 %>%
  filter(player == "Roger Federer") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()
# plot supports theory

gs_matches_final2 %>%
  filter(player == "Rafael Nadal") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()
# still showing downward trend for nadal

gs_matches_final2 %>%
  filter(player == "Novak Djokovic") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()
# novaks top30 line is nearly straight -- him winning not dependent on his serve percentage?
```

```{r}
# win vs second serve

ggplot(gs_matches_final2, aes(x = second_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.1) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw() +
  coord_cartesian(xlim = c(.5, 1))

gs_matches_final2 %>%
  filter(player == "Roger Federer") %>%
  ggplot(., aes(x = second_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()

gs_matches_final2 %>%
  filter(player == "Rafael Nadal") %>%
  ggplot(., aes(x = second_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw() +
  stat_smooth(aes(x = first_serve, y = win, color = opponent_top30))+
  theme_bw()  +
  scale_colour_manual(values = c("blue", "green", "purple", "pink")) +
    stat_smooth(method = "glm", method.args = c("binomial"), aes(x = first_serve, colour = opponent_top30))

gs_matches_final2 %>%
  filter(player == "Rafael Nadal") %>%
  pivot_longer(c("first_serve", "second_serve"), names_to = "servetype",
    values_to = "serveperc") %>%
  ggplot(., aes(x = serveperc, y = win, color = interaction(opponent_top30,
    servetype))) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial"))

>>>>>>> 86c8f41e1481121e7c1b47a42ae571f36236ae02
## something like this?
## I would also knit this file to make sure it runs from start to finish...
## you'll probably need to add some stuff at the beginning in order to make
## that happen

## plotting question: the easiest way to do this might actually be to first
## get the data set into longer 


gs_matches_final2 %>%
  filter(player == "Novak Djokovic") %>%
  ggplot(., aes(x = second_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw() 
```


```{r}
# faceting

matches_to_facet <-
  gs_matches_final2 %>%
  group_by(player) %>%
  summarise(matches = n()) %>%
  filter(matches >= 100) 

matches_to_facet2 <- semi_join(gs_matches_final2, matches_to_facet, by = "player")

ggplot(matches_to_facet2, aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.15) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  facet_wrap("player")

ggplot(matches_to_facet2, aes(x = first_serve, y = win, color = opponent_ranking)) +
  geom_jitter(height = 0.12, alpha = 0.15) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  facet_wrap("player")

ggplot(matches_to_facet2, aes(x = first_serve, color = opponent_top30)) +
  geom_boxplot() +
  facet_wrap("player")






gs_matches_final2 %>%
  filter(player == "John Isner") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()

gs_matches_final2 %>%
  filter(player == "John Isner") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_ranking)) +
  geom_jitter(height = 0.12, alpha = 0.25) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  theme_bw()

## this is the most surprisng to me

gs_matches_final2 %>%
  filter(player == "John Isner") %>%
  ggplot(., aes(x = first_serve, color = interaction(opponent_top30, surface))) +
  geom_boxplot()

# how can we look into why this is happening?
# one thought: top 30 or outside might not be "good enough" to as a 
# covariate: there's considerable difference between playing someone in
# the top 3 and someone ranked 29. For example, Isner had a win against
# a top 30 player in Milos raonic, ranked 24, that has some leverage





gs_matches_final2 %>%
  filter(player == "John Isner" & first_serve < 0.60) %>%
  select(opponent, loser_rank)
## as far as looking into why, you could use the information in the 
## point-level data set to gain some understanding. In particular, 
## how fast is he serving? Is he serving slower, on average,
##  in matches where he is
## getting more 1st serves in? That on its own could explain the 
## downward sloping trend.
```






```{r}
gs_matches_final2 %>%
  filter(player == "Roger Federer") %>%
  ggplot(., aes(x = first_serve, y = win, color = opponent_top30)) +
  geom_jitter(height = 0.12, alpha = 0.15) +
  stat_smooth(method = "glm", method.args = c("binomial")) +
  facet_wrap("tourney_name")

gs_matches_final2 %>%
  filter(player == "Roger Federer") %>%
  ggplot(., aes(x = first_serve, color = opponent_top30)) +
  geom_boxplot() +
  facet_wrap("tourney_name")

# Fed never lost to someone outside of top 30 at Roland Garros?
# Something weird is happening where wimbleodn is only tournament with both lines downward sloping
# but also only tournament where first serve seems higher for top 30

## That's fine, I think. The outside top 30 wimbledon line just has one
## loss observation to go on, and the standard errors on the curves are
## very large, probably too large to think that there is a decreasing pattern
## at Wimbledon.
```









All of this is really getting at having a random effect for the opponent. It would still be possible to include this and still make the Shiny app for different players. You'd end up setting the random effect for opponent to 0 to get this "global" graph of effect of first serve percentage on winning while also actually accounting for the level of the opponent within the model. But at some point, we'll have to think about balancing time with the extra work that this would entail. Something to just think about for now (no need to do anything with it, at least until we finish the mixed effects document thing).

I think this would be the way to go if possible.  See Figure 8.15 on this document we've been reading: <https://bookdown.org/roback/bookdown-bysh/ch-multilevelintro.html> That really sums up the issue at hand. It might also be helpful to come up with an example in this data set. It won't be as "clear" as the toy example in this book but it could help get the point across.







