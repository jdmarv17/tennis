---
title: "rf_markdown"
author: "Josh Marvald"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(party)
library(tidyverse)
library(forcats)
library(randomForest)
source("merging_variables.R")
```


```{r}
# more variables for rf

# get indicator variables for each player winning the point
rf_df <-
  rf_df %>%
  mutate(p1_point = case_when(
    PointWinner == 1 ~ 1,
    PointWinner == 2 ~ 0
  )) %>%
  mutate(p2_point = case_when(
    PointWinner == 1 ~ 0,
    PointWinner == 2 ~ 1
  ))

# add variables for cumulative point totals at every point
rf_df <-
  rf_df %>%
  group_by(slam, year, p1, p2) %>%
  mutate(p1_total_points = 
           cumsum(p1_point)) %>%
  mutate(p2_total_points = 
           cumsum(p2_point)) %>%
  ungroup() %>%
  mutate(point_dif = 
           p1_total_points - p2_total_points) %>%
  mutate(surface = case_when(
    slam == "ausopen" ~ "hard",
    slam == "usopen" ~ "hard",
    slam == "frenchopen" ~ "clay",
    slam == "wimbledon" ~ "grass"
  ))
  
```


```{r}
### preparing test and train
  
# get rid of NAs
rf_df <-
  rf_df %>%
  filter(is.na(set_advantage) == F & is.na(game_advantage) == F & is.na(P1Score) == F & is.na(P2Score) == F
        & is.na(rank_dif) == F & is.na(result) == F & is.na(point_dif) == F)



# make score a factor so there arent problems with 40-Ad or Ad-40
rf_df$P1Score <- as.factor(rf_df$P1Score)
rf_df$P2Score <- as.factor(rf_df$P2Score)

# get list of matches
match_list <-
  rf_df %>%
  select(year, slam, p1, p2) %>%
  distinct()

set.seed(7)

# sample matches
sample_size <- floor(.7 * nrow(match_list))
index <- sample(seq_len(nrow(match_list)), size = sample_size)

train_matches <- match_list[index, ]
test_matches <- match_list[-index, ]

# join with rf_df to get train and test points
train <- inner_join(rf_df, train_matches)
test <- inner_join(rf_df, test_matches)

```


```{r}
# fit random forest

# add importance, P1Score, P2Score
rf1 <- randomForest(result ~ set_advantage + game_advantage + rank_dif + point_dif, data = train, ntree = 25, mtry = 3, importance = T)

train$result <- as.factor(train$result)
rf2 <- ctree(result ~ rank_dif + point_dif, data = train)

plot(rf2, type = "simple")
```


```{r}
preds <- predict(rf1, test)
test <- 
  test %>%
  ungroup %>%
  mutate(predictions = preds) 
```


```{r}
# add categorical variable for probability ranges
test <-
  test %>%
  mutate(ranges = case_when(
    predictions < .1 ~ "ones",
    predictions >= 0.1 & predictions < 0.2 ~ "tens",
    predictions >= 0.2 & predictions < 0.3 ~ "twenties",
    predictions >= 0.3 & predictions < 0.4 ~ "thirties", 
    predictions >= 0.4 & predictions < 0.5 ~ "fourties",
    predictions >= 0.5 & predictions < 0.6 ~ "fifties",
    predictions >= 0.6 & predictions < 0.7 ~ "sixties",
    predictions >= 0.7 & predictions < 0.8 ~ "seventies",
    predictions >= 0.8 & predictions < 0.9 ~ "eighties",
    predictions >= 0.9 ~ "nineties"
  )) %>%
  mutate(ranges2 = case_when(
    predictions >= 0.5 ~ "win",
    predictions < 0.5 ~ "loss"
  ))

test %>%
  group_by(ranges) %>%
  summarise(prop = mean(result))

test %>%
  group_by(ranges2) %>%
  summarise(prop = mean(result))

# make indicator variable to see if prediction was correct
test <- 
  test %>%
  mutate(correct = case_when(
    predictions >= 0.5 & result == 1 ~ 1,
    predictions >= 0.5 & result == 0 ~ 0,
    predictions < 0.5 & result == 1 ~ 0,
    predictions < 0.5 & result == 0 ~ 1
  )) %>%
  mutate(num_sets = (as.numeric(p1Set) + as.numeric(p2Set)))
```


```{r}
test$num_sets <- as.factor(test$num_sets)

# table showing proportion correct in each set
test %>%
  group_by(num_sets) %>%
  summarise(correct = sum(correct), total = n(), prop = correct/total)

# plot point number vs whether prediction correct
test %>% 
  filter(p1 == "Roger Federer" & p2 == "Stan Wawrinka" & slam == "ausopen" & year == "2017") %>%
  ggplot(., aes(y = correct, x = PointNumber, color = num_sets)) +
  geom_point()
# why are points where num_sets = 0 at point numbers past 1, 2 sets

```



