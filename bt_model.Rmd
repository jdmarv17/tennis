---
title: "bt_model"
author: "Josh Marvald"
date: "6/8/2020"
output: html_document
---

```{r}
library(tidyverse)
library(BradleyTerry2)
source("merging_matches.R")
```


```{r}
# only keep players with enough matches
matches_keep <-
  gs_matches_final2 %>%
  group_by(player) %>%
  summarise(matches = n()) %>%
  filter(matches >= 100) 

# leave out 2015 to check
gs_decade_small <- 
  gs_decade %>%
  filter(winner_name %in% matches_keep$player & loser_name %in% matches_keep$player) %>%
  separate(tourney_id, into = c("year", "tourn_id"), sep = "-" ) %>%
  filter(year != 2015) 

gs_decade_small_2015 <-
  gs_decade %>%
  filter(winner_name %in% matches_keep$player & loser_name %in% matches_keep$player) %>%
  separate(tourney_id, into = c("year", "tourn_id"), sep = "-" ) %>%
  filter(year == 2015)
```

```{r}
# split data into winners and losers
winners_df <-
  gs_decade_small %>%
  select(winner_name, w_serveperc, w_secondserve) %>%
  mutate(win1 = 1, id = as.factor(winner_name), first_serve = w_serveperc)

winners_2015 <-
  gs_decade_small_2015 %>%
  select(winner_name, w_serveperc, w_secondserve) %>%
  mutate(win1 = 1, id = as.factor(winner_name), first_serve = w_serveperc)

losers_df <-
  gs_decade_small %>%
  select(loser_name, l_serveperc, l_secondserve) %>%
  mutate(win2 = 0, id = as.factor(loser_name), first_serve = l_serveperc) 

losers_2015 <-
  gs_decade_small_2015 %>%
  select(loser_name, l_serveperc, l_secondserve) %>%
  mutate(win2 = 0, id = as.factor(loser_name), first_serve = l_serveperc)
```


```{r}
levels(winners_df$id)
levels(losers_df$id)

levels(winners_2015$id)
levels(losers_2015$id)
```


```{r}
# fit models

# mod with just player 
mod1 <- BTm(cbind(win1, win2), player1 = winners_df, player2 = losers_df, formula = ~ id + first_serve:id + first_serve, id = "id", data = gs_decade_small)

summary(mod1)

# mod with player and tournament
mod2 <- BTm(cbind(win1, win2), player1 = winners_df, player2 = losers_df, formula = ~ id + first_serve:id + first_serve + tourney_name, id = "id", data = gs_decade_small)

summary(mod2)
```


```{r}
gs_decade_small_2015 <-
  gs_decade_small_2015 %>%
  mutate(pred = predict(mod1))

newdata <- list(contests = data.frame(
  winner = factor(gs_decade_small_2015$winner_name, levels = matches_keep$player),
  loser = factor(gs_decade_small_2015$loser_name, levels = matches_keep$player)))

predict(mod1, newdata)
predict(mod1, gs_decade_small_2015)


```

